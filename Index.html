<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Project 11: Advanced VR Data Lab</title>
    <!-- A-Frame VR Engine -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>

    <style>
        /* --- 2D DASHBOARD STYLES --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; overflow: hidden; }
        
        #dashboard {
            position: absolute;
            top: 10px; left: 10px;
            width: 320px;
            height: 90vh;
            background: rgba(10, 15, 20, 0.95);
            border: 2px solid #00d2ff;
            color: #e0f7ff;
            z-index: 1000;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.2);
        }

        h2 { text-align: center; margin: 0 0 15px 0; color: #00d2ff; font-weight: 300; letter-spacing: 2px; }
        
        .control-group { background: #1a2530; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #334; }
        label { font-size: 12px; color: #8899aa; display: block; margin-bottom: 5px; }
        
        select, input[type=range] { width: 100%; background: #000; border: 1px solid #445; color: white; padding: 5px; }
        
        .btn-row { display: flex; gap: 5px; margin-top: 10px; }
        button {
            flex: 1; padding: 8px; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn-green { background: #008800; color: white; } .btn-green:hover { background: #00aa00; }
        .btn-red { background: #880000; color: white; } .btn-red:hover { background: #aa0000; }
        .btn-blue { background: #004488; color: white; } .btn-blue:hover { background: #0066aa; }

        /* DATA LOG OUTPUT */
        #data-log-container {
            flex-grow: 1;
            background: black;
            border: 1px solid #333;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            overflow-y: auto;
            padding: 5px;
            margin-top: 10px;
        }
        .log-entry { border-bottom: 1px solid #222; padding: 2px 0; display: flex; justify-content: space-between; }
        .log-entry span { color: #00ff00; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>

    <!-- 2D CONTROL DASHBOARD -->
    <div id="dashboard">
        <h2>DATA VISUALIZER</h2>
        
        <!-- Controls -->
        <div class="control-group">
            <label>MATERIAL TEST SUBJECT</label>
            <select id="mat-select" onchange="resetSim()">
                <option value="liquid">Salt Solution (Ionic)</option>
                <option value="metal">Copper Conductor (Metallic)</option>
            </select>
        </div>

        <div class="control-group">
            <label>HEATING RATE</label>
            <input type="range" id="speed-slider" min="1" max="5" value="2">
        </div>

        <div class="btn-row">
            <button class="btn-green" id="btn-toggle" onclick="toggleSim()">START</button>
            <button class="btn-red" onclick="resetSim()">RESET</button>
        </div>
        <div class="btn-row">
             <button class="btn-blue" onclick="exportCSV()">DOWNLOAD CSV</button>
        </div>

        <!-- Output Display -->
        <div style="margin-top: 15px; font-weight: bold; font-size: 14px; border-top: 1px solid #444; padding-top:10px;">
            OUTPUT MONITOR
        </div>
        <div id="data-log-container">
            <div style="color: #666; text-align: center;">Waiting for data...</div>
        </div>
    </div>

    <!-- 3D VR SCENE -->
    <a-scene background="color: #000">
        
        <!-- Environment: A clean grid for scientific look -->
        <a-entity environment="preset: tron; grid: 2x2; gridColor: #222; skyType: atmosphere;"></a-entity>

        <!-- User Camera -->
        <a-entity position="0 0 2.5">
            <a-camera look-controls wasd-controls position="0 1.6 0"></a-camera>
            <a-entity oculus-touch-controls="hand: left"></a-entity>
            <a-entity oculus-touch-controls="hand: right"></a-entity>
        </a-entity>

        <!-- MAIN LAB APPARATUS -->
        <a-entity position="0 0 -2">
            
            <!-- 1. The Big Screen (Virtual Monitor) -->
            <a-entity position="0 2.8 -1">
                <!-- Screen Frame -->
                <a-box width="3.2" height="1.2" depth="0.1" color="#333"></a-box>
                <!-- Screen Content -->
                <a-plane id="vr-screen-bg" width="3" height="1" position="0 0 0.06" color="#000"></a-plane>
                
                <a-text id="vr-text-readout" 
                        value="SYSTEM STANDBY" 
                        align="center" position="0 0.2 0.07" 
                        color="#00ff00" width="6"></a-text>
                
                <a-text id="vr-text-sub" 
                        value="Select material to begin" 
                        align="center" position="0 -0.2 0.07" 
                        color="#aaaaaa" width="3"></a-text>
            </a-entity>

            <!-- 2. The 3D Graph Plotter -->
            <a-entity position="0 0 0">
                <!-- Platform -->
                <a-box width="4" height="0.2" depth="4" color="#111" position="0 -0.1 0"></a-box>
                
                <!-- Axis Lines -->
                <a-entity line="start: -2 0 0; end: 2 0 0; color: red"></a-entity> <!-- X: Temp -->
                <a-entity line="start: -2 0 0; end: -2 2.5 0; color: green"></a-entity> <!-- Y: Cond -->

                <!-- Axis Labels -->
                <a-text value="TEMP (C)" position="2.2 0 0" color="red" scale="0.6 0.6 0.6"></a-text>
                <a-text value="COND (uS)" position="-2 2.7 0" color="green" scale="0.6 0.6 0.6" align="center"></a-text>

                <!-- Data Points Container -->
                <a-entity id="graph-container"></a-entity>
            </a-entity>

        </a-entity>

    </a-scene>

    <!-- LOGIC SCRIPT -->
    <script>
        // --- GLOBAL VARIABLES ---
        let running = false;
        let temp = 20.0;
        let points = [];
        let historyData = []; // Stores data for CSV export
        const maxGraphPoints = 60;
        
        // --- DOM ELEMENTS ---
        const uiLog = document.getElementById('data-log-container');
        const uiBtn = document.getElementById('btn-toggle');
        const vrTextMain = document.getElementById('vr-text-readout');
        const vrTextSub = document.getElementById('vr-text-sub');
        const vrScreenBg = document.getElementById('vr-screen-bg');
        const graphCont = document.getElementById('graph-container');
        const matSelect = document.getElementById('mat-select');
        const speedSlider = document.getElementById('speed-slider');

        // --- MAIN SIMULATION LOOP (Runs every 100ms) ---
        setInterval(() => {
            if(!running) return;

            // 1. Calculate Physics
            const speed = parseInt(speedSlider.value) * 0.2;
            temp += speed;

            // Reset temp if it goes too high for the graph loop
            if(temp > 150) {
                running = false;
                uiBtn.innerText = "RESTART";
                uiBtn.style.background = "#008800";
                return;
            }

            // Material Logic
            let cond = 0;
            if(matSelect.value === 'liquid') {
                // Liquid: Linear increase (Simple: y = mx + b)
                cond = 300 + (temp * 10);
            } else {
                // Metal: Linear decrease
                cond = 1500 - (temp * 8); 
                if(cond < 0) cond = 0;
            }

            // 2. Update Displays
            updateVRDisplay(temp, cond);
            logDataToUI(temp, cond);

            // 3. Plot 3D Point
            create3DPoint(temp, cond);

            // 4. Save for export
            historyData.push({ time: new Date().toLocaleTimeString(), temp: temp.toFixed(1), cond: cond.toFixed(0) });

        }, 100);

        // --- FUNCTIONS ---

        function toggleSim() {
            running = !running;
            uiBtn.innerText = running ? "PAUSE" : "RESUME";
            uiBtn.style.background = running ? "#ccaa00" : "#008800";
        }

        function resetSim() {
            running = false;
            temp = 20.0;
            points.forEach(p => p.parentNode.removeChild(p));
            points = [];
            historyData = [];
            uiLog.innerHTML = '<div style="color:#666;text-align:center;">Log Cleared</div>';
            
            uiBtn.innerText = "START";
            uiBtn.style.background = "#008800";
            
            // Reset VR Screen
            vrTextMain.setAttribute('value', "SYSTEM READY");
            vrTextMain.setAttribute('color', "#00ff00");
            vrTextSub.setAttribute('value', "Waiting for input...");
            vrScreenBg.setAttribute('color', "#000");
        }

        function updateVRDisplay(t, c) {
            // Standard Update
            vrTextMain.setAttribute('value', `${t.toFixed(1)} C  |  ${c.toFixed(0)} uS`);
            vrTextSub.setAttribute('value', matSelect.value.toUpperCase() + " ANALYSIS");

            // WARNING ALERT SYSTEM
            if(t > 90) {
                vrScreenBg.setAttribute('color', "#500"); // Red background
                vrTextMain.setAttribute('color', "#ff0000"); // Red text
                if(Math.floor(Date.now() / 500) % 2 === 0) { // Blink effect
                    vrTextMain.setAttribute('value', "!! CRITICAL TEMP !!");
                }
            } else {
                vrScreenBg.setAttribute('color', "#000");
                vrTextMain.setAttribute('color', "#00ff00");
            }
        }

        function logDataToUI(t, c) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<div>${t.toFixed(1)}°C</div> <span>${c.toFixed(0)} µS</span>`;
            uiLog.appendChild(entry);
            // Auto scroll to bottom
            uiLog.scrollTop = uiLog.scrollHeight;
        }

        function create3DPoint(t, c) {
            // Map values to 3D coordinates
            // Temp (20-150) -> X (-2 to 2)
            const x = ((t - 20) / 130) * 4 - 2;
            // Cond (0-2000) -> Y (0 to 2.5)
            const y = (c / 2000) * 2.5;

            // Create Sphere
            const sphere = document.createElement('a-sphere');
            sphere.setAttribute('radius', '0.06'); // Slightly bigger for visibility
            sphere.setAttribute('position', `${x} ${y} 0`);
            
            // Dynamic Color
            // Low Temp = Blue, High Temp = Red
            const hue = 240 - ((t - 20) / 130 * 240); // 240(Blue) -> 0(Red)
            sphere.setAttribute('color', `hsl(${hue}, 100%, 50%)`);

            graphCont.appendChild(sphere);
            points.push(sphere);

            // Animate Graph Flow (Move old points backward in Z)
            points.forEach(p => {
                let currentPos = p.getAttribute('position');
                p.setAttribute('position', {
                    x: currentPos.x, 
                    y: currentPos.y, 
                    z: currentPos.z - 0.08 // Flow speed
                });
            });

            // Cleanup old points
            if(points.length > maxGraphPoints) {
                let old = points.shift();
                old.parentNode.removeChild(old);
            }
        }

        function exportCSV() {
            if(historyData.length === 0) {
                alert("No data to export! Run the simulation first.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Time,Temperature(C),Conductivity(uS)\n"; // Header

            historyData.forEach(row => {
                csvContent += `${row.time},${row.temp},${row.cond}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "vr_lab_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
